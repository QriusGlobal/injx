# Changelog

All notable changes to this project are documented here.

This file is managed by Release Please and updated automatically as part of the release process.

- Do not edit this file manually; changes are generated from Conventional Commits.

## [Unreleased]

### Added
- New `analyzer.py` module with pure dependency analysis functions for better separation of concerns
- New `cleanup_strategy.py` module with IntEnum-based cleanup strategies for memory efficiency
- New `provider_record.py` module with frozen dataclass for immutable provider metadata
- New `scope_data.py` module with functional approach to scope management
- New `scope_context.py` module with module-level scope management functions
- Comprehensive docstrings for all new modules and functions for better documentation generation
- New `period_tasks/` directory for project planning documentation
- PRD-004 document outlining Phase 2 container optimizations with Gemini architectural review
- Performance benchmarking strategy with statistical significance testing
- Architectural evolution section in CLAUDE.md documenting planned improvements
- Logging strategy documentation for balanced observability

### Changed
- **BREAKING**: Converted `CleanupStrategy` from class to IntEnum for 92% memory reduction (56+ bytes → 4-8 bytes)
- Refactored cleanup architecture to functional-first approach with class methods instead of instance methods
- Refactored `Container._auto_register()` to eliminate local imports and broad exception handling
- Refactored `Container.get()` and `Container.aget()` methods to eliminate deeply nested conditionals (4-5 levels reduced to max 2-3)
- Extracted resolution logic into focused helper methods following single responsibility principle
- Improved code organization with comprehensive docstrings for all methods
- Replaced MagicMock with proper Mock(spec=) in tests for better type safety

### Performance
- **51% memory reduction** per provider registration (272 → 132 bytes) through functional architecture
- Cleanup strategies now precomputed at registration time, eliminating runtime type checking
- Optimized dependency resolution fast path for ~85% cache hit rate scenario
- Reduced method complexity from 100+ lines to max 30 lines per method
- Eliminated unnecessary conditional branches in hot code paths
- Zero runtime overhead for cleanup strategy determination

### Architecture
- Adopted functional-first paradigm: data structures + pure functions over OOP ceremony
- Implemented SOLID principles through functional composition
- Used frozen dataclasses with `__slots__` for memory-efficient immutable structures
- Leveraged Python 3.13+ features (IntEnum, match statements) for cleaner code
- Controlled type cast points for maintaining type safety with internal type erasure

## 1.2.0 — 2025-09-14

### Performance Improvements

- **perf: optimize circular dependency detection from O(n²) to O(1)** using set-based tracking instead of tuple concatenation
- **perf: fix memory leaks in singleton lock management** - locks are now properly cleaned up after initialization
- **perf: remove incorrect transient caching** - transient scope now correctly creates new instances on every resolution

### Bug Fixes

- **fix: transient scope violation** - removed WeakValueDictionary caching that violated transient semantics
- **fix: singleton lock memory leak** - replaced defaultdict with explicit lock management
- **fix: removed dead code** - eliminated unused dependency tracking

### Features

- **feat: batch operations** - added `batch_register()`, `batch_resolve()`, and `batch_resolve_async()` for efficient bulk operations
- **feat: performance monitoring** - added `get_stats()` and `cache_hit_rate` property for monitoring container performance
- **feat: contextual overrides** - added `use_overrides()` context manager for scoped dependency overriding

### Internal Improvements

- **test: comprehensive memory profiling** - added 7 memory profiling tests using tracemalloc
- **test: O(1) cycle detection validation** - added 10 tests verifying cycle detection performance
- **test: performance benchmarking** - added 4 new performance tests
- **docs: cleaned up redundant comments** - removed unnecessary inline comments, keeping only non-obvious explanations
- **docs: updated API documentation** - added v1.2.0 features and performance characteristics

## 1.1.1 — 2025-09-04

Improvements and fixes since 1.1.0:

- ci: deterministic Gates (format→lint→types) then tests and docs
- ci: PR head checkout, concurrency cancel-in-progress, avoid duplicate runs on PR branches
- ci(pytest): add coverage (pytest-cov), junit xml, xdist; upload coverage to Codecov
- docs: add status/badges table (CI, quality, package, community, meta)
- cleanup: remove generated site/ assets and local runner/type logs; ignore site/ and .basedpyright_full.txt
- refactor: centralize default container in `pyinj.defaults`; split protocols package; typing fixes for wrappers and context cleanups

## 1.1.0 — 2025-09-04

- feat(container): add `register_context` for sync/async context-managed providers with per-scope cleanup (request/session/singleton)
- feat(container): enforce immutable registrations; re-registering the same token raises `ValueError`
- feat(api): add `register_context_sync` and `register_context_async` helpers; typed overloads on `register_context`
- refactor(cleanup): remove broad introspective resource tracking; container now tracks resources registered via context-managed registration while request/session scopes continue to clean up scoped resources
- docs: update examples to use `register_context_sync/async`; clarify nested request scopes and async cleanup ordering
- docs: add LLM Guide for concise usage in agent/tool contexts
- tests: refactor to context-managed registrations; fix asyncpg/httpx test indentation; update circular dependency expectation
